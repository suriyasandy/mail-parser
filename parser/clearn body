import re
from bs4 import BeautifulSoup

SIGNATURE_MARKERS = [
    "regards", "thanks", "thank you", "sincerely", "best regards", "yours truly", "warm regards"
]

HEADER_LINE_REGEX = re.compile(
    r"^\s*(From|To|Cc|Bcc|Sent|Subject|Date):", re.IGNORECASE
)

def clean_html_email(html: str) -> str:
    soup = BeautifulSoup(html, "html.parser")

    # Remove metadata
    for tag in soup(["style", "script", "head", "title", "meta"]):
        tag.decompose()

    # Remove blockquotes (older replies)
    for block in soup.find_all("blockquote"):
        block.decompose()

    # Extract text
    full_text = soup.get_text(separator="\n")
    cleaned_lines = []

    skip_signature = False
    for line in full_text.splitlines():
        line_strip = line.strip()

        # Skip header lines
        if HEADER_LINE_REGEX.match(line_strip):
            continue

        # Start skipping signature lines once triggered
        if not skip_signature and any(marker in line_strip.lower() for marker in SIGNATURE_MARKERS):
            skip_signature = True

        if not skip_signature and line_strip:
            cleaned_lines.append(line_strip)

    cleaned_text = "\n".join(cleaned_lines)
    cleaned_text = re.sub(r"\n{2,}", "\n\n", cleaned_text)

    return cleaned_text.strip()
