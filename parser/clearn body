from bs4 import BeautifulSoup
import re

SIGNATURE_MARKERS = [
    "Regards", "Best Regards", "Thanks", "Thank you", "Sincerely", "Yours truly"
]

def clean_html_email(html: str) -> str:
    soup = BeautifulSoup(html, "html5lib")

    # Remove scripts, styles, meta, headers
    for tag in soup(["style", "script", "head", "title", "meta"]):
        tag.decompose()

    # Remove blockquotes (older replies)
    for block in soup.find_all("blockquote"):
        block.decompose()

    # Optional: Remove horizontal rules or known disclaimers
    for hr in soup.find_all("hr"):
        hr.decompose()

    # Flatten out to text for signature stripping
    full_text = soup.get_text(separator="\n")

    # Remove email headers (From:, To:, etc.)
    cleaned_lines = []
    for line in full_text.splitlines():
        if re.match(r"^\s*(From|To|Sent|Subject|Cc):", line, re.IGNORECASE):
            continue
        cleaned_lines.append(line)

    cleaned_text = "\n".join(cleaned_lines)

    # Stop at first signature marker
    for sig in SIGNATURE_MARKERS:
        sig_pos = cleaned_text.lower().find(sig.lower())
        if sig_pos > 0:
            cleaned_text = cleaned_text[:sig_pos]
            break

    return cleaned_text.strip()
